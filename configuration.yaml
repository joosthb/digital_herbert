homeassistant:
  customize: !include customize.yaml
  auth_providers:
    - type: homeassistant
    - type: trusted_networks
      trusted_networks:
        - 192.168.99.0/24
      trusted_users:
        192.168.99.0/24: 0329e83b43944107971af6871e31b252


# Configure a default setup of Home Assistant (frontend, api, etc)
default_config:

# Text to speech
# tts:
#   - platform: google_translate

counter:
  scene_counter1:
    initial: 0
    step: 1

sensor:
  # Import gps data
  - platform: gpsd
  # Invert and integrate power values
  - platform: integration
    source: sensor.dyn_wal_inverted
    name: dynamo_wal_energie
    round: 2
  - platform: integration
    source: sensor.solar_inverted
    name: solar_energie
    round: 2
  - platform: integration
    source: sensor.vermogen_verbruikers
    name: verbruikers_energie
    round: 2
  - platform: integration
    source: sensor.invoeders
    name: invoeders_energie
    round: 2

template:
  - sensor:
      - name: "dyn_wal_inverted"
        unit_of_measurement: "W"
        state_class: measurement
        device_class: power
        state: >
          {% set vermogen_dynamo = states('sensor.vermogen_dynamo')|float*-1 %}
          {{ vermogen_dynamo | abs if vermogen_dynamo > 0.0 else 0.0 }}
      - name: "solar_inverted"
        unit_of_measurement: "W"
        state_class: measurement
        device_class: power
        state: >
          {% set vermogen_solar = states('sensor.vermogen_solar')|float*-1 %}
          {{ vermogen_solar | abs if vermogen_solar > 0.0 else 0.0 }}
      - name: "invoeders"
        unit_of_measurement: "W"
        state_class: measurement
        device_class: power
        state: >
          {% set vermogen_solar = states('sensor.vermogen_solar')|float*-1 %}
          {% set vermogen_dynamo = states('sensor.vermogen_dynamo')|float*-1 %}
          {% set invoeders = (vermogen_solar + vermogen_dynamo) | float %}
          {{ invoeders | abs if invoeders > 0.0 else 0.0 }}



# Create daily total usage
#utility_meter:
#  daily_energy:
#    source: sensor.energy_total
#    cycle: daily
#    #unit_of_measurement: Wh


group: !include groups.yaml
automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

recorder:
  # only record herbert health status
  include:
    entities:
      - switch.acculader
      - binary_sensor.beweging
      - sensor.energie_verbruik_totaal
      - sensor.vermogen_dynamo
      - sensor.vermogen_solar
      - sensor.vermogen_verbruikers
      - sensor.accuspanning
      - sensor.dynamo_wal_energie
      - sensor.solar_energie
      - sensor.verbruikers_energie
      - sensor.invoeders_energie
      - sensor.gps
      - sensor.luchtvochtigheid
      - sensor.temperatuur
      - zone.home
     # And keep them long
  purge_keep_days: 60

history:
  # only show herbert health status
  include:
    entities:
      - switch.acculader
      - binary_sensor.beweging
      - sensor.energie_verbruik_totaal
      - sensor.vermogen_dynamo
      - sensor.vermogen_solar
      - sensor.vermogen_verbruikers
      - sensor.accuspanning
      - sensor.dynamo_wal_energie
      - sensor.solar_energie
      - sensor.verbruikers_energie
      - sensor.invoeders_energie
      - sensor.gps
      - sensor.luchtvochtigheid
      - sensor.temperatuur
      - zone.home

shell_command:
  halt: sudo /sbin/halt

  # entry for the Telegram Bot
telegram_bot:
  - platform: polling
    api_key: !secret telegram_api_key
    allowed_chat_ids:
      - 451219846

# entry for the notifier
notify:
  - name: hb_tel
    platform: telegram
    chat_id: 451219846

#homekit:
#  filter:
#    include_domains:
#      - switch
#      - light

# HomeKit start delay for stability funcks stuff up
#homekit:
#  auto_start: false

#automation:
#  - alias: 'Start HomeKit'
#    trigger:
#      - platform: homeassistant
#        event: start
#    action:
#      - delay: 00:05  # Waits 5 minutes
#      - service: homekit.start
#
